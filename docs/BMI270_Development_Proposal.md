# BMI270 HAL開発要件提案書

**作成日**: 2025年10月26日
**対象**: StampFly HAL - BMI270 6軸IMU実装
**目的**: 飛行制御に必要な機能要件の明確化と開発ロードマップの策定

---

## 📊 現状分析

### ✅ 実装済み機能

#### 1. 基本SPI通信層（完全実装）
- SPI通信基盤確立（8MHz、安定動作）
- レジスタ読み取り/書き込み機能
- バースト書き込み機能
- CHIP_ID読み取り成功（0x24確認済み）
- I2C→SPIモード切替機能

#### 2. 初期化シーケンス（部分実装）
- ✅ SPI HALセットアップ
- ✅ I2C→SPIモード切替
- ⚠️ Bosch公式設定ファイル（8192バイト）アップロード機能
  - 実装済みだが、書き込みテストで失敗
  - INIT_ADDRレジスタへの書き込み検証が問題
- ⏳ 初期化完了待機処理（実装済み、未検証）
- ⏳ 電源管理設定（実装済み、未検証）

#### 3. センサー設定（実装済み、未検証）
- 加速度計設定（±4g、100Hz ODR）
- ジャイロスコープ設定（±1000dps、100Hz ODR）
- レンジ設定とスケールファクター計算

#### 4. データ取得API（実装済み、未検証）
- `read_accel()` - 加速度データ（m/s²単位）
- `read_gyro()` - 角速度データ（rad/s単位）
- `read_temperature()` - 温度データ（℃単位）
- `get_status()` - センサーステータス
- `get_error_status()` - エラー状態

#### 5. ユーティリティ機能
- ソフトリセット
- ステータス確認
- エラー診断

### ❌ 未実装・問題のある部分

#### 1. 初期化プロセスの完了（最優先）
- **問題**: INIT_ADDRレジスタ書き込みテストでエラー
  - 書き込み: 0x00 → 読み取り: 0xFF（常にFFが返る）
  - このため初期化が途中で中断
- **影響**: センサーが使用不可状態

#### 2. 高度な機能（未実装）
- 割り込み設定（Data Ready信号等）
- FIFO機能（バッファリング）
- BMI270固有の高度な機能
  - Any-motion検出
  - No-motion検出
  - Step counter（歩数計）
  - Activity recognition

#### 3. キャリブレーション（未実装）
- ジャイロオフセット補正
- 加速度計オフセット補正
- 温度補償

#### 4. 実機検証（未実施）
- センサーデータ取得の実機確認
- 精度検証
- ノイズ特性評価

---

## 🎯 飛行制御要件分析

### クアッドコプター飛行制御の技術要件

#### 1. サンプリングレート
- **必須**: 500Hz以上の制御ループ
  - 典型的な飛行制御は4msレイテンシ（250Hz）～2ms（500Hz）
  - 500Hzは安定した姿勢制御に必要な最低ライン
- **現状**: 100Hz ODR設定（不足）
- **改善**: 800Hz～1600Hz ODRへの変更が必要

#### 2. センサー精度
- **ジャイロスコープ**: 飛行制御の主センサー
  - ドリフト誤差が姿勢推定の精度に直結
  - 温度変化・振動の影響を受けやすい
- **加速度計**: ピッチ/ロール角計算
  - 直接使用せず、センサーフュージョンで使用
  - 重力ベクトルから傾斜角推定

#### 3. センサーフュージョン
**必須技術:**
- **相補フィルタ（Complementary Filter）**
  - 高周波数ジャイロ信号（K1=0.98）
  - 低周波数加速度計信号（K2=0.02）
  - 実装が簡単、計算コスト低

- **カルマンフィルタ（Kalman Filter / EKF）**
  - より高精度な姿勢推定
  - 計算コスト高
  - 研究・高度な制御に有用

#### 4. データフロー要件
```
BMI270 → センサーフュージョン → 姿勢推定 → PID制御 → モーター制御
 (500Hz)      (500Hz)            (500Hz)      (500Hz)     (500Hz)
```

#### 5. リアルタイム性
- **割り込み駆動型データ取得**（推奨）
  - Data Ready割り込みでデータ取得
  - ポーリングによるCPU負荷削減
- **FIFOバッファリング**（オプション）
  - データロスト防止
  - バーストリード効率化

---

## 📋 開発要件提案

### フェーズ1: 初期化問題の解決（最優先・必須）

#### 目的
現在ブロックされている初期化プロセスを完了させる

#### タスク
1. **INIT_ADDRレジスタ書き込みテストの見直し**
   - [ ] テストロジックの削除または警告レベルに変更
   - [ ] CHIP_ID読み取り成功を初期化成功条件とする
   - [ ] より適切なレジスタでのテスト（PWR_CONF等）

2. **設定ファイルアップロードの検証**
   - [ ] 実機での設定ファイルアップロード動作確認
   - [ ] INTERNAL_STATUS レジスタ監視
   - [ ] 初期化完了待機処理の動作確認

3. **センサー有効化の確認**
   - [ ] 加速度計・ジャイロスコープの電源ON確認
   - [ ] データ取得可能状態の確認
   - [ ] ステータスレジスタでの検証

**期待成果:**
- BMI270が正常に初期化完了
- センサーデータ取得可能状態
- エラーなしでのアプリケーション起動

**優先度**: 🔴 **最高（即座に実施）**

---

### フェーズ2: 基本データ取得の実機検証（必須）

#### 目的
センサーデータ取得機能の動作確認と精度評価

#### タスク
1. **データ取得機能の検証**
   - [ ] `read_accel()` 実機動作確認
   - [ ] `read_gyro()` 実機動作確認
   - [ ] `read_temperature()` 実機動作確認
   - [ ] データの妥当性検証（範囲チェック）

2. **データ品質評価**
   - [ ] 静止状態でのノイズレベル測定
   - [ ] スケールファクター検証（1G重力加速度確認）
   - [ ] ジャイロドリフト測定
   - [ ] 温度センサー精度確認

3. **Teleplotによる可視化**
   - [ ] 加速度データのリアルタイムプロット
   - [ ] 角速度データのリアルタイムプロット
   - [ ] 傾斜検出の確認（デバイスを傾ける）
   - [ ] 回転検出の確認（デバイスを回転）

**期待成果:**
- センサーデータが正常に取得できる
- データの精度が確認できる
- Teleplotで波形確認できる

**優先度**: 🟠 **高（フェーズ1完了後すぐ）**

---

### フェーズ3: 高速化とリアルタイム性向上（飛行制御の基盤）

#### 目的
500Hz制御ループに対応する高速データ取得を実現

#### タスク
1. **ODR（Output Data Rate）の最適化**
   - [ ] 800Hz ODR設定への変更
   - [ ] 1600Hz ODR設定のテスト
   - [ ] SPI通信速度の最適化（8MHz → 10MHz）
   - [ ] データ取得レイテンシ測定

2. **割り込み駆動型データ取得の実装**
   - [ ] Data Ready割り込みピン設定
   - [ ] GPIO割り込みハンドラー実装
   - [ ] 割り込み駆動型データ取得フロー
   - [ ] ポーリング方式との比較

3. **バーストリード最適化**
   - [ ] 加速度+ジャイロの一括読み取り（12バイト）
   - [ ] レジスタ0x0C～0x17の連続読み取り
   - [ ] 読み取り時間の最小化

4. **パフォーマンス測定**
   - [ ] データ取得頻度測定
   - [ ] 実効サンプリングレート確認
   - [ ] CPU負荷測定
   - [ ] タイミングジッター測定

**期待成果:**
- 500Hz以上のデータ取得レート達成
- 低レイテンシなデータ取得
- CPU負荷の最適化

**優先度**: 🟡 **中高（飛行制御実装前に必要）**

---

### フェーズ4: センサーフュージョンの実装（姿勢推定）

#### 目的
ジャイロ+加速度計データから正確な姿勢を推定

#### タスク
1. **相補フィルタ実装（推奨開始点）**
   - [ ] 相補フィルタアルゴリズム実装
   - [ ] ロール/ピッチ/ヨー角算出
   - [ ] フィルタ係数の調整（K1=0.98, K2=0.02）
   - [ ] 実機での動作確認

2. **カルマンフィルタ実装（高度版）**
   - [ ] 拡張カルマンフィルタ（EKF）実装
   - [ ] 状態空間モデル構築
   - [ ] ノイズ共分散行列調整
   - [ ] 相補フィルタとの性能比較

3. **Madgwick AHRS（代替案）**
   - [ ] Madgwickアルゴリズム実装
   - [ ] クォータニオンベース姿勢推定
   - [ ] ジャイロバイアス自動補償

4. **BMM150磁気センサー統合**
   - [ ] 3軸磁気センサーデータ取得
   - [ ] ヨー角ドリフト補正
   - [ ] 9軸センサーフュージョン

**期待成果:**
- ロール/ピッチ角の正確な推定
- ジャイロドリフトの補正
- 安定した姿勢データ

**優先度**: 🟡 **中（飛行制御実装で必須）**

---

### フェーズ5: キャリブレーションとチューニング（飛行品質向上）

#### 目的
センサー精度を最大化し、安定した飛行を実現

#### タスク
1. **ジャイロキャリブレーション**
   - [ ] 静止状態でのオフセット測定
   - [ ] オフセット値の不揮発性メモリ保存
   - [ ] 起動時自動キャリブレーション
   - [ ] 温度補償機能

2. **加速度計キャリブレーション**
   - [ ] 6面キャリブレーション（X/Y/Z軸各±1G）
   - [ ] スケールファクター補正
   - [ ] オフセット補正
   - [ ] 重力ベクトル正規化

3. **フィルタパラメータチューニング**
   - [ ] 相補フィルタ係数の最適化
   - [ ] カルマンフィルタノイズ行列調整
   - [ ] 飛行テストによる実証

4. **キャリブレーションユーティリティ**
   - [ ] キャリブレーションツール実装
   - [ ] GUIまたはCLIインターフェース
   - [ ] キャリブレーションデータ管理

**期待成果:**
- 高精度なセンサーデータ
- ドリフト最小化
- 再現性のある飛行特性

**優先度**: 🟢 **中低（飛行制御実装後に調整）**

---

### フェーズ6: 高度な機能実装（研究・応用向け）

#### 目的
BMI270固有の高度な機能を活用した付加価値提供

#### タスク
1. **FIFO機能**
   - [ ] FIFOバッファ設定
   - [ ] バーストリード実装
   - [ ] データロスト防止機能
   - [ ] FIFOオーバーフロー検出

2. **モーション検出機能**
   - [ ] Any-motion割り込み設定
   - [ ] No-motion割り込み設定
   - [ ] 自動スリープ/ウェイク機能
   - [ ] 省電力モード実装

3. **診断・デバッグ機能**
   - [ ] セルフテスト機能
   - [ ] エラー検出とリカバリー
   - [ ] 詳細ログ出力
   - [ ] 性能プロファイリング

4. **応用機能（オプション）**
   - [ ] Step counter（歩数計）
   - [ ] Activity recognition（活動認識）
   - [ ] 姿勢異常検出
   - [ ] クラッシュ検出

**期待成果:**
- 高度な機能提供
- 研究・教育への応用
- デバッグ効率向上

**優先度**: 🔵 **低（余裕があれば実装）**

---

## 🛠️ 技術仕様提案

### 推奨センサー設定（飛行制御最適化）

#### 加速度計設定
```cpp
// 推奨設定
ODR: 800Hz または 1600Hz  // 現在100Hz → 変更必要
Range: ±4g または ±8g     // 現在±4g → 適切
Bandwidth: Normal mode    // デフォルト
```

**理由:**
- 800Hz以上で500Hz制御ループに十分なマージン
- ±4gは通常飛行に十分（アクロバティック飛行は±8g）

#### ジャイロスコープ設定
```cpp
// 推奨設定
ODR: 800Hz または 1600Hz  // 現在100Hz → 変更必要
Range: ±1000dps または ±2000dps  // 現在±1000dps → 適切
Bandwidth: Normal mode    // デフォルト
```

**理由:**
- ±1000dps: 穏やかな飛行（推奨開始点）
- ±2000dps: アクロバティック飛行

#### 割り込み設定
```cpp
// Data Ready割り込み
INT1ピン: Data Ready信号出力
割り込みモード: Push-pull, Active High
サンプリング: 割り込み駆動型データ取得
```

**理由:**
- ポーリングによるCPU負荷削減
- 正確なタイミングでデータ取得
- リアルタイム性向上

---

## 📈 期待される効果（飛行制御への貢献）

### 技術的効果

1. **姿勢推定精度の向上**
   - 高速サンプリング（500Hz+）による滑らかな姿勢データ
   - センサーフュージョンによるドリフト補正
   - 正確なロール/ピッチ/ヨー角推定

2. **制御応答性の向上**
   - 低レイテンシなデータ取得
   - 割り込み駆動による即座な反応
   - 500Hz PID制御ループの実現

3. **飛行安定性の向上**
   - 高精度な姿勢情報によるPID制御最適化
   - ノイズ除去による滑らかな制御
   - 外乱への迅速な対応

### 教育・研究への貢献

1. **学習教材としての価値**
   - リアルタイムセンサーデータ可視化
   - センサーフュージョンアルゴリズムの実装学習
   - PID制御パラメータ調整の実践

2. **研究プラットフォーム**
   - 制御アルゴリズムの検証
   - センサーフュージョン手法の比較
   - フライトデータ記録・解析

3. **拡張性**
   - 他センサーとの統合基盤
   - 高度な制御アルゴリズムの実装基盤
   - カスタマイズ可能なプラットフォーム

---

## 🗓️ 開発スケジュール提案

### 短期（1-2週間）
- [x] プロジェクト整理（完了）
- [x] 開発ユーティリティ整備（完了）
- [ ] **フェーズ1: 初期化問題解決** ← **次のステップ**
- [ ] **フェーズ2: 基本データ取得検証**

### 中期（1ヶ月）
- [ ] フェーズ3: 高速化・リアルタイム性向上
- [ ] フェーズ4: センサーフュージョン実装
- [ ] 基本的な飛行制御実装

### 長期（2-3ヶ月）
- [ ] フェーズ5: キャリブレーション
- [ ] フェーズ6: 高度な機能
- [ ] 総合的な飛行性能評価

---

## 🎯 即座に実施すべきアクション

### 1. 初期化問題の修正（最優先）

**問題箇所:**
`components/stampfly_hal/src/bmi270.cpp` の `test_spi_communication()` 関数

**修正方針:**
- INIT_ADDRレジスタへの書き込みテストを削除
- CHIP_ID読み取り成功を初期化成功条件とする
- または、テストを警告レベルに変更して続行可能にする

**期待結果:**
- BMI270初期化が完了
- センサーデータ取得が可能になる
- main.cppのアプリケーションが正常起動

### 2. データ取得の実機確認

**確認項目:**
- 加速度データが妥当な範囲か（静止時に約9.8m/s² on Z軸）
- ジャイロデータがゼロ付近か（静止時）
- 温度データが室温付近か（20-30℃）

**ツール:**
- `utilities/monitor.py` でTeleplot形式出力確認
- Teleplotアプリで波形可視化

### 3. 次フェーズへの準備

**技術調査:**
- 相補フィルタアルゴリズムの学習
- PID制御理論の復習
- FreeRTOSタスク間通信の確認

---

## 📚 参考資料

### BMI270関連
- [BMI270データシート](https://www.bosch-sensortec.com/media/boschsensortec/downloads/datasheets/bst-bmi270-ds000.pdf)
- Bosch Sensortec GitHub（公式ドライバー参考）

### センサーフュージョン
- 相補フィルタ理論
- カルマンフィルタ入門
- Madgwick AHRS論文

### 飛行制御
- PID制御チューニング手法
- クアッドコプター制御理論
- ESP-Drone（Espressif公式ドローンプロジェクト）

---

## 結論

**現状**: BMI270は基本機能が実装済みだが、初期化問題でブロック中

**最優先タスク**: `test_spi_communication()` の修正で初期化を完了させる

**次のステップ**: データ取得の実機検証 → 高速化 → センサーフュージョン → 飛行制御

**最終目標**: 500Hz制御ループで安定飛行可能なStampFly HALの完成

このロードマップに従って段階的に実装を進めることで、StampFlyの飛行制御に必要な高品質なIMU HALを実現できます。
